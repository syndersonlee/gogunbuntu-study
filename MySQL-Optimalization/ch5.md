# ch5 서버 설정 최적화

- mySQL 설정 조작시 확인 해야 하는 것   
    - 버퍼 풀 및 로그 파일 크기의 기본 값이 적절한 지 확인
    - 특별한 이유가 없으면 설정은 조작하는 것이 아님

## MySQL 설정이 동작하는 방법

- 일반적인 설정 파일은 /etc/mysql/my.cnf 혹은 /etc/my.cnf에서 확인 가능
    
### 구문, 범위 및 다이나믹 여부

- 주의해야 할 것 사항
    - max_connections 변수는 전역
    - sort_buffer_size는 기본적으로 전역이나 세션별로 설정 가능
    - join_buffer_size는 기본적으로 전역이고 세션별로 설정 가능하지만, 테이블 조인 시에 하나의 버퍼를 할당 받아 여러 조인 버퍼 사용 가능
- Default 설정 시 전역 변수 값으로 지정

### 지속 시스템 변수

- DB를 재시작 시 설정 파일에 지정된 값으로 되돌아가는 것을 확인
- MySQL 8.0 이후 부터는 SET PERSIST를 런타임 시 설정하고 이후 디스크에 저장해서 가져옴

### 변수 설정 부작용

- 변수 동적 설정 시 서버가 많은 작업을 수행해야 하므로 주의
- 일부 변수 동적 변경 시 수행 결과
    - table_open_cache
        - 다음 스레드가 테이블을 열 시에 효과 수행
        - 변수 값을 확인하여 테이블에 캐시 삽입
    - thread_cache_size
        - 다음 스레드가 테이블을 열 시에 효과 수행
        - 나중 연결에서 사용할 수 있도록 스레드 캐시
    - read_buffer_size
        - 버퍼가 필요할 경우 전체 메모리에 지정 사이즈 만큼 할당
    - read_rnd_buffers_size
        - 필요한 만큼 메모리 할당
- 특정 쿼리가 필요할 때 값을 올리는 게 나음

### 변수 변경 계획

- 변수 설정 시 잘못 설정할 경우 메모리 부족 현상 및 서버 스왑 현상 발생 가능
- 버전 제어를 통해 설정 파일 변경 사항 추적
- 인덱스 추가 같은 내용을 통해 스키마 최적화 선행 필요

### 하지 말아야 할것

- 비율로 튜닝하는 것은 금지
- 튜닝 보다는 최적화, 설정이라는 단어를 선호
- 인기 있는 메모리 공식은 예전 버전 이야기라 너무 믿을 필요 없다

### MySQL 설정 파일 생성

#### 최소 설정

- 책 참조
- 일반적으로 해당 설정 파일들을 /var/lib/mysql에서 사용
- 다만 중요한 것은 open_files_limits 옵션
    - 일반적인 Linux 시스템에서 작게 설정할 경우 too many files 이슈 발생

### MySQL 서버 상태 변수 점검

- mysqladmin extended-status -ri60
    - 60초마다 상태 변수에 대한 점진적 변경 확인

## 메모리 사용량 설정

- innodb_dedicated_server만 사용하면 일반적으로 50% - 75%를 사용
- 나머지 기타 시스템 메모리 설정에 대해 최소 25%를 남김

### 연결 당 메모리 요구사항

- 하나의 쿼리 연결 당 최악의 상황을 모두 가정하여 할당하는 것은 옳지 않음
- 하나의 쿼리 내에서 프리페어드 스테이트먼트 쿼리를 쓸 경우 많은 쿼리를 실행 할 수도 있음

### 운영 체제를 위한 메모리 예약

### InnoDB 버퍼 풀

- InnoDB는 버퍼 풀에 크게 의존하므로 충분한 메모리 할당 필요 / 이후 메모리에 대한 모니터링 필요
- 다만 큰 버퍼 풀은 긴 종료 시간과 워밍업 시간을 야기
    - InnoDB 종료 시에 데티 페이지를 기록하기 때문에 종료하는 데에 오랜 시간이 걸림
    - InnoDB는 더티 페이지가 임계값을 초과하면 숫자를 낮추기 위해 페이지를 빠르게 플러시
- MySQL이 다시 백업 시작 시 캐시는 비어 있고, 이를 <b>콜드 캐시</b>라 명명

### 스레드 캐시

- MySQL은 스레드를 제거 할 때, 해당 스레드를 캐시에 보관
- 이에 해당하는 변수는 thread_cache_size 캐시에 보관 할 수 있는 스레드 수를 지정
- 스레드는 일반적으로 256KB를 사용하므로 그리 크지 않음
- 매우 크게 설정할 필요 X

## MySQL I/O 동작 설정

- 일반적인 사용을 위해 중요한 체크 사항
    - InnoDB 로그 파일 크기
    - InnoDB가 로그 버퍼를 플러시 하는 법
    - InnoDB가 I/O를 수행하는 방법

### InnoDB 트랜잭션 로그

- InnoDB는 트랜잭션 커밋 비용을 줄이기 위해 로그를 사용
- InnoDB에서 로그를 flush 할 때 랜덤I/O를 사용
- 랜덤 I/O 비용 > 순차 I/O 비용이기 때문에, 트랜잭션 로그는 이를 순차 I/O로 처리
- *innodb_log_file_size* / *innodb_log_files_in_group* 수치는 쓰기 성능에 큰 영향을 끼침

### 로그 버퍼

- 데이터 변경 시 **로그 버퍼**에 커밋 혹은 버퍼가 꽉 찼을 시 flush
- 이 버퍼 크기를 제어하는 변수가 *inno_buffer_size* 

#### InnoDB 로그 버퍼를 플러시하는 방법

- 로그 버퍼를 디스크에 플러시 할 때 뮤텍스가 버퍼를 잠금
- *inno_flush_log_at_trx_commit*을 제어 해서 로그 버퍼 플러시 되는 위치와 빈도를 제어 가능
    - 0 : 1초마다 로그 파일 플러시, 커밋은 무관계
    - 1 : 기본 설정, 커밋 될 때 마다 디스크에 플러시
    - 2 : 로그 버퍼를 로그 파일에 write, 그러나 디스크 플러시는 진행 X -> 1초마다 innoDB에 플러시
- 0,2는 비정상 종료, 정전 시 최대 1초의 데이터 손실 위험 / Duarability 속성을 포기

#### InnoDB가 로그 파일과 데이터 파일을 열고 플러시 하는 방법

- *inno_flush_method* 옵션 - 대부분의 케이스에서 0_DIRECT 옵션이 좋음

### InnoDB 테이블 스페이스

- **테이블스페이스**에 데이터를 보관

#### 테이블스페이스 설정

- 테이블스페이스는 MySQL 페이지를 전부 삭제하고 재부팅하지 않는 이상 줄이는 것이 불가능
- 공간이 부족할 경우 테이블스페이스를 확장하도록 설정 가능
- *inno_file_per_table* 옵션 사용 시 테이블당 하나의 파일을 사용 하도록 InnoDB 설정 가능

#### 이전 행 버전과 테이블스페이스

- 이전 버전을 tablespace에 저장하기 때문에 purge process(gc와 비슷) purge를 선처리해 인덱스와 테이블스페이스 사용을 줄일 수 있음
- *innodb_max_purge_lag* 변수를 크게 설정하면 성능은 크게 떨어지지만 테이블스페이스 과점유 보다는 나음

### 다른 I/O 설정

- *sync_big* 바이너리 로그 디스크로 플러시하는 옵션 1로 설정하여야 트랜잭션 데이터와 동기화 X
- 1로 두어 발생하는 안정성 >>>>> I/O 성능 저하

## MySQL 동시성 설정

- MySQL 5.7 미만 버전 사용 시 버전 InnoDB 업데이트로 동시성 문제 해결 가능
- 병목 현상 발생 시 thread_concurrency 수치를 조절하여 한 번에 커널에 들어갈 수 있는 스레드 제한
- 위 문제에서 스레드 진입이 최대값을 초과 시 두 단계로 해결 가능
    1. 휴면 기간 제한
    2. 커널 내부의 스레드 내에 티켓에 대한 작업량 제한

## 안전 설정

- *max_connect_erros*
    - 설정 오류 혹은 연결 미완료 요청 등에 방어하는 옵션
- *max_connections*
    - 최대 연결 옵션
- *skip_name_reslove*
    - dns lookup 옵션 비활성화 옵션
- *sql_mode*
    - 서버 옵션 변경 키워드 (변경 비추천)
- *read_only and super_read_only*
    - 데이터베이스에 변경 사항을 쓸 수 있는 유일한 옵션
    - 읽기 전용 옵션

## 고급 InnoDB 설정

- *innodb_autoinc_lock_mode*
    - 자동 증가 기본키 생성 방법 제어
    - 동시성이 높아질 경우 설정 확인 필요
- *inno_buffer_pool_instances*
    - 다중 버퍼 풀로 세그먼트를 나누는 옵션
- *innodb_io_capacity*
    - 현재 가능한 I/O 용량 소개
- *innodb_read_io_threads* / *innodb_write_io_threads*
    - 읽기와 쓰기에 해당하는 innodb 쓰레드 수 제어
- *innodb_strict_mode*
    - DDL 쿼리를 사용할 때 오류를 발생하도록 처리하는 옵션
- *innodb_old_blocks_time*
    - LRU 알고리즘 상에서 young generation -> old generation으로 옮기는 데 걸리는 시간
    - 1000정도가 적당하다고 판단