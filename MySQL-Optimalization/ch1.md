# Ch1 MySQL 아키텍처

## MySQL의 논리적 아키텍처

- MySQL는 3가지 계층으로 구성
    - 클라이언트
        - 네트워크 기반 클리이언트/서버 도구 또는 서버에 필요한 연결 처리, 인증, 보안
    - 쿼리 파싱, 분석, 최적화 및 기본 제공 함수
    - 스토리지 엔진을 포함하는 부분
        - 데이터를 저장하고 검색하는 역할
        - 스토리지 엔진 API를 활용하여 처리

### 연결 관리 및 보안

- 각 클라이언트 연결 간 고유한 스레드 가짐
- 클라이언트에서 연결할 때 서버는 클라이언트의 권한 확인

### 최적화 및 실행

- MySQL은 쿼리를 분석하여 생성 / 쿼리 키워드를 통해 옵티마이저에 힌트 전달하여 쿼리 최적화
- MySQL 8.0 기준으로 쿼리 캐시가 사라지고 인메모리 DB로 캐싱

## 동시성 제어

- 두 개의 이상 쿼리가 데이터 변경 시 동시성 제어 문제 발생

### 읽기 / 쓰기 잠금

- 동시성 제어의 고질적인 문제의 해결책은 다음과 같음
    - 공유 잠금
    - 전용 잠금
- 잠금 매커니즘의 종류
    - 읽기 잠금 : 공유 되거나 상호 차단 X
    - 쓰기 잠금 : 배타적, 읽기 잠금과 기타 쓰기 잠금을 모두 차단

### 잠금 세분화

- 일반적으로 변경할 데이터가 포함된 부분만 잠금
- 잠금에는 리소스 소모가 필요
- 잠금 오버헤드와 데이터 안전 사이는 트레이드 오프
- MySQL은 이에 대한 선택권 제공

#### 테이블 잠금

- MYSQL의 가장 기본적 잠금이자 가장 낮은 오버헤드
- 테이블 전체에 대한 잠금
- 'READ LOCAL' 테이블 잠금으로 일부 유형에 대한 동시 쓰기 허용

#### 행 잠금

- 행 잠금은 스토리지 엔진에 구현

## 트랜잭션

- ACID는 장애를 방지

### 격리 수준

#### READ UNCOMMITTED

- Dirty Read 발생 가능
- 커밋 되지 않는 데이터을 볼 수도 있음

#### READ COMMITTED

- 커밋되어 있는 내용을 볼 수 있으며, 변경 사항은 다른 사람에게 표시되지 않음 

#### REPEATABLE READ

- 동일한 트랜잭션 내에 변경 사항은 이후 읽기 에서도 동일하게 보이도록 함
- 팬텀리드가 발생 가능
- MySQL의 기본 격리 수준

#### SERIALIZABLE

- 모든 행에 잠금을 걸어 잠금 경합을 발생 시킴

| 격리 수준 | Dirty Read | Non-Repeatable Read | Phantom Read | Lock Read |
| -- | -- | -- | -- | -- |
| READ UNCOMMITED | 가능 | 가능 | 가능 | 불가 |
| READ COMMITTED | 불가 | 가능 | 가능 | 불가 |
| REPEATABLE READ | 불가 | 불가 | 가능 | 불가 |
| SERIALIZABLE | 불가 | 불가 | 불가 | 가능 |

### 교착

- 서로가 서로의 트랜잭션에 항목에 대해서 잠금을 하여 더 이상 진행하지 못하는 상태
- 일반적인 해결책은 교착 상태 탐지 및 시간 초과 기능 구현
- InnoDB는 순환 종속성을 탐지
- 일부 혹은 전체를 롤백 처리 후 재 시도

### 트랜잭션 로깅

- 디스크에 영역에 트랜잭션 처리를 하기 전에 로그를 먼저 기입 : 로그 선행 기법
- 이를 통해 문제시 재처리 가능

### MYSQL에서의 트랜잭션

- MySQL은 InnoDB 엔진의 트랜잭션을 기반으로 처리

#### AUTO COMMIT 이해

- 가역적인 쿼리 문을 트랜잭션으로 처리되어 즉시 커밋

#### 트랜잭션에서 스토리지 엔진 혼합

- 단일 트랜잭션에서 서로 다른 엔진을 안정적으로 혼용불가
- 따라서 롤백 시 데이터베이스 트랜잭션 롤백이 어려움

#### 암시적 잠금 명시적 잠금

- InnoDB는 표시되지 않는 명시적 잠금 또한 지원
- SELECT .. FOR SHARE 및 UPDAET 지원

## 다중 버전 동시성 제어

- InnoDB는 트랜잭션 ID를 사용하여 MVCC 구현
- Undo 레코드가 언두 로그에 기록되고 롤백 하는 방법을 찾는 방식
- REPEATAABLE READ 및 READ COMMITED 격리 수준에서만 작동

## 복제

## 데이터 파일 구조

- .ibd 파일에 포함된 데이터 딕셔너리로 재설계

## InnoDB 엔진

- MySQL의 범용 스토리지 엔진
- 팬텀 리드를 방지하는 next-key 잠금 전략
- 내부 최적화 또한 포함

### JSON 문서 지원

- JSON 문서 값 매핑 기능 지원
- 읽기 엑세스 쿼리 속도 증가

### 데이터 딕셔너리의 변화

- 8.0 기준으로 메타 데이터 스토리지를 제거하고 데이터 테이블 스토리지 사용
