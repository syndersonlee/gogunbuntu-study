# ch6 스키마 설정과 관리
## 최적의 데이터 유형과 선택

- 데이터 유형에 관련 없이 가지는 특징
    - 작을 수록 좋음
        - 더 작은 CPU 캐시 공간, 메모리를 사용
    - 단순할 수록 좋음
        - 데이터 작업을 처리하는 데에 더 적은 CPU 주기를 필요
        - 데이터 처리 시 리소스 낭비가 적음
    - 가급적 NULL 회피
        - nullable한 칼럼의 경우 스토리지 낭비가 심함
- 첫 번째로 일반 유형 클래스 선택
- 특정 유형을 그 다음으로 선택

### 정수

- 정수와 실수 두가지 타입으로 *TINYINT*, *SMALLINT*, *MEDIUMINT*, *INT*, *BIGINT* 존재
    - 각각 8, 16, 24, 32, 64비트 사용
- *UNSIGNED* 속성 가질 수 있음
- 정수 계산에는 일반적으로 *BIGINT* 사용 / DECIMAL, DOUBLE 같은 집계 함수는 예외

### 실수

- *FLOAT* 및 *DOUBLE* 부동 소수점 연산으로 근사 값 지원
    - *FLOAT*는 4바이트 / *DOUBLE*은 8바이트
- 정밀한 연산 요구 시 *DECIMAL* 사용 필요
- 더 정확한 연산 필요시 BIGINT로 저장 후 배수로 저장하는 것이 나음

#### 문자열 유형

##### VARCHAR와 CHAR 유형

- VARCHAR
    - 가변 길이 문자열
    - 공간 절약의 필요성이 있고 조각화의 문제가 발생하지 않는 경우
    - UTF-8 등의 인코딩 비추천
- CHAR
    - 고정 길이 문자열

- MD5로 암호화 할 경우 CHAR이 적당 (길이가 고정이므로)

##### BLOB과 TEXT 유형

- 대용량 텍스트를 바이너리 혹은 문자열로 저장
- 고유 엔진에서 특별한 외부 공간에 저장 가능
- BLOB과 TEXT의 차이점은 TEXT에만 문자 집합과 데이터 정렬 존재

##### 문자열 대신 ENUM 사용하기

- 열을 ENUM을 변환한 후 조인이 더 빠름, ENUM열을 VARCHAR 열로 조인하는 속도는 느림
- 다만 열을 변환했을 경우 테이블 크기가 1/3로 작아짐

### Date와 Time 유형

- DATETIME
    - 1마이크로초 정밀도로 정수 압축 시간으로 저장
- TIMESTAMP
    - 1970년 이후 UNIX 타임스탬프 형식으로 저장
    - DATETIME보다 훨씬 크기가 작음
    - 2038년 까지 사용 가능

### 비트 팩 데이터 유형

- BIT
    - 참거짓을 단일 열에 저장할 수 있는 기술
    - ASCII CODE를 저장하는 방식으로 보면 됨
- SET
    - 참/거짓을 많이 저장해야하는 경우
- 어플리케이션 권한을 저장하는 ACL을 제어할 때 사용

### JSON 데이터

- RDBMS에 저장하는 것은 올바른 형태는 아님
- SQL 버전이 더 적은 용량 사용
- 

### 식별자 선택

- **식별자**는 행을 참조하고 행을 고유하도록 하는 역할
- UNSIGNED 같은 속성을 사용해서 정확하게 일치하도록 해야함

##### 정수 타입

- AUTO_INCREMENT 등을 같이 사용가능
- 적합한 크기를 가지고 있어야 함

##### ENUM과 SET

- 식별자에는 미적합

##### 문자열 타입

- 가급적 미사용 추천
- UUID()나 MD5() 같은 임의의 문자열에도 조심할 필요가 있음
- 쿼리 지연 가능성
- UUID 같은 경우 *BINARY(16)* 열에 저장하거나 HEX() 함수로 검색

### 특별한 유형의 데이터

- IPv4의 경우 가끔 VARCHAR(15)를 통해 저장
- 다만 이는 unsigned로 저장하는 것이 원래 맞음

## MySQL의 스키마 설계 문제

### 너무 많은 열

- MySQL 스토리지 엔진 API
    - 서버와 스토리지 엔진 사이의 행을 행 버퍼 형식으로 복사 후 버퍼를 디코딩
    - 너무 많은 열을 사용 할 경우 CPU 사용량이 너무 커질 수 있음

### 너무 많은 조인

- MySQL 조인당 테이블 수가 61개로 제한
- 이보다 적더라도 Query Plan 계산 비용이 늘어날 수 있으므로 12개 이하로 사용 권장 

### 지나친 ENUM 사용

- Enum 남용시 의심스러운 설계

### 위장한 ENUN

- ENUM을 사용하면 하나의 값, SET을 사용하면 하나 이상의 값 보유 가능
- 혼동이 올 수 있는 값을 쓰는 것 금지

### NULL의 지나친 배제

- 너무 알 수 없는 값에는 NULL 값을 사용하는 것이 나을 수 있음
- 예시 - yyMMddHHMMSS 양식에서 모두 0으로 기입하는 것

## 스키마 관리

- 스키마 변경 관리 시 운영의 중단 없이 수행 하도록 처리 해야 함

### 데이터 저장소 플랫폼의 일부인 스키마 관리

#### 성공을 위한 파트너 팀 구성

#### 지속적인 통합과 스키마 관리 통합

#### 스키마 변경에 대한 소스 제어
- 유료 옵션
    - 비용
    - 온라인 스키마 관리
    - 즉각적인 통합
    - 오픈소스의 사용

#### 운영 중의 스키마 변경 실행
- 기본 DDL문 시 논블로킹 지원하는 스키마에 사용

#### 외부 도구를 사용한 스키마 변경 실행
    - 주의 사항
        - 트리거의 제한
        - 성능에 영향을 끼치는 트리거
        - 동시 마이그래션 실행
        - 외래 키 에 대한 제약 조건

#### 스키마 변경을 위한 CI/CD 파이프 라인
- 처리 시 고려 내용
    - 스키마 소스 구성
    - 안전을 위한 기본 구성
    - 팀별 파이프라인 유연성