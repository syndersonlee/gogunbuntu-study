# 6장 파티셔닝

- 데이터셋이 크거나 질의 처리량이 높은 경우 -> 파티션으로 쪼개는 작업 = 샤딩

데이터 파티셔닝

- 비공유 클러스터를 활용하여 저장
- 여러 디스크에 데이터를 나누어 저장
- 질의 부하를 여러 프로세스에 부하 분산


## 파티셔닝과 복제

- 하나의 노드에 여러 파티션 저장 가능
- 또한 각 노드에 팔로워와 리더를 분할해서 저장

## 키-값 데이터 파티셔닝

- 데이터 질의 부하가 노드 사이에 분산이 되지 않고 쏠리는 현상 - Skewed(쏠림)
- 불균형하게 부하가 높은 파티션 - 핫스팟

### 키 범위 기준 파티셔닝

- 각 파티션에 특정값의 최소값부터 최대값까지 키를 할당
- 키 범위가 반드시 동일할 필요 없이 데이터에 맞추어 조정

특징

- Range Scan이 간결
- 특정한 접근 패턴이 핫스팟 유발

### 키의 해시값 기준 파티셔닝

- 해시 함수를 사용한 모든 키를 파티션에 할당
- 일관성 해싱
    - 파티션 경계가 크기가 동일 하도록 분산처리 하는 방법
    - CDN의 대규모 인터넷 캐시 시스템에서 부하를 균등 분산하는 방법
    - 실제 DB에서는 잘 사용하지 않음
- 해시 함수는 Range Scan에 대한 장점이 없음
- 카산드라 DB의 경우 위 문제를 해결하기 위해 첫 부분에만 해싱을 적용하여 파티션 결정에 사용
- 한 사용자가 수정한 정보는 한 파티션 내에서 정렬된 상태로 저장

### 쏠린 작업부하와 핫스팟 완화

- 특정한 극단적인 상황에서는 항상 동일한 키를 사용 
    - 유명인에 대한 색인
    - 요청이 많은 경우 쓰기를 숫자를 붙여 분산 -> 쓰기 분산
    - 읽기 에대한 추가 작업 필요

## 파티셔닝과 보조 색인

보조 색인

- 특정 값이 발생한 모든 항목을 검색하는 수단
- RDB의 핵심 요소
- Sola 및 Elastic Search의 존재 이유
- 파티션에 깔끔하게 대응이 어려움

### 문서 기준 보조 색인 파티셔닝

- 각 파티션이 자신에 파티션에 대한 보조 색인만 유지
- 타 파티션에 대한 영향 고려 X
- Local Index라 명명
- 모든 파티션에 명령을 보내서 이를 수집 후 중복을 가려 내야 함
    - 스캐터/개더
- 질의에 큰 비용이 소모
- 단일 질의 + 여러 보조 색인 사용 시 비용이 많이 듬

### 용어 기준 보조 색인 파티셔닝

- 각 보조 색인을 값을 저장하는 방식 중 각 파티션에 개별적으로 저장하되 모든 파티션에 대한 정보를 저장
- 용어 기준으로 파티셔닝을 진행
- 읽기가 효율적이지만, 쓰기가 비효율적
- 현실에서는 비동기로 갱신

## 파티션 재균형화

- 데이터베이스에 생기는 변화
    - 질의 처리량 증대에 의한 CPU 부하
    - 데이터 셋 크기 증가에 의한 디스크 및 램 추가
    - 장비 장애로 인한 장비 보수
- 위 이슈로 인한 노드 이동 과정 - 재균형화
- 해당 과정 이후 
    - 재균형화 후, 부하를 클러스터 내에 있는 노드들 사이에 균등하게 분배
    - 재균화 중간에도 데이터베이스는 읽기/쓰기 요청 수용 필요
    - 재균형화 실행 과정 사이 디스크 I/O 부하를 최소화

### 재균형화 전략

#### 쓰면 안되는 방법 : 해시값에 모드 N 연산을 실행

- mod 전략을 사용해서 나누기를 할 경우
- 노드 개수의 변화에 따라 대부분의 키 변화가 발생하여 재균형 비용이 지나치게 증대

#### 파티션 개수 고정

- 클러스터에 노드가 추가되면서 기존 노드에서 신 노드에 파티션을 가져가도록 진행
- 성능이 좋은 노드에 파티션을 더 할당 가능
- 리악, 엘라스틱 서치, 카우치 베이스, 볼드모트에서 사용

일반적인 파티션 구성 방법

- 최초에 설정한 파티션 값이 대체로 최대치 / 충분히 높은 값
- 파티션이 적으면 재균형화 시 복구 시 비용이 큼
- 파티션이 많을 시 오버헤드가 심각

#### 동적 파티셔닝

- HBase나 리싱크DB의 경우는 파티션을 동적으로 생성
- 부하 균형을 위해 타 노드로 파티션을 전달
- 초기에 지정되기 전에는 사전 정보가 없어 이를 처리하기 위해 설정 필요 - <b>사전 분할</b>

#### 노드 비례 파티셔닝

- 노드 당 파티션의 개수를 고정 시킴
- 새 노드가 추가 될 경우 각 노드의 절반의 파티션은 그대로 두고 나머지 절반을 할당
- 카산드라에서는 이를 관리 할 수 있는 알고리즘 추가
- 해시 기반 파티셔닝을 사용하는데, 일관성 해싱의 정의와 유사

### 운영: 자동 재균형화와 수동 재균형화

- 완전 자동 재균형화와 수동 재균형화의 중간 지점을 선택하는 것이 좋음
- 파티션 할당을 제안만 하고 관리자가 확정
- 특정 노드에 과부하 혹은 응답 값이 과중된 경우 재균형화 과정 중에 타 노드에 추가로 악영향을 끼칠 수도 있음

## 요청 라우팅

요청이 들어왔을 때 어느 노드에서 처리해야하는 지 아는 방법
- Zookeeper같은 노드 코디네이터를 통해 해당 노드로 직접 라우팅
    - HBase, 솔라클라우드, 카프카, 몽고DB, 헬릭스
- 가십 프로토콜을 사용해서 변화를 노드 사이에 퍼트림
    - 임의의 노드에서 요청을 받았을 시 해당 노드로 정보 전달
    - 카산드라, 리악
- 카우치베이스의 경우 moxi라는 라우팅 계층을 설정

### 병렬 질의 진행

- 데이터웨어하우스에서 쓰이는 대규모 병렬 처리(MPP)의 경우 고속 병렬 실행을 사용

## 정리

파티셔닝 기법
- 키 범위 파티셔닝
    - Range Scan이 편함 
    - Hot Spot 발생 가능
- 해시 파티셔닝
    - 부하 분산에 편함
    - 노드 추가나 제거시 파티션을 통째로 이동

보조색인과의 상호 작용
- 문서 파티셔닝 색인
    - 단일 파티션에서 개별적으로 저장
    - 문서 조회 시 스캐터/게더 실행
- 용어 파티셔닝 색인
    - 기본키와 모든 파티션에 있는 레코드를 포함해서 저장
    - 읽기 시 단일 파티션에서 실행 가능 하나 쓰기 시에는 모든 파티션에 작업이 필요

