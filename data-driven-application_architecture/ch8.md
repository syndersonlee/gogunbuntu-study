# ch8 분산 시스템의 골칫거리

- 엔지니어로서 각종 결함이 생기더라도 제 역할을 수행하도록 시스템 구축 필요성이 있음
- 이에 대한 해결 방법 확인 필요

## 결함과 부분 장애

- 일반적인 소프트웨어는 소프트웨어 연산 전체에 대해 Atomic 하도록 구현
- 단일 하드웨어 안에서는 이에 따라 전체 Failover 혹은 전체 성공으로 분류
- 다만 네트워크로 연결된 소프트웨어는 상황이 다름
- 이에 따른 부분적으로 특정 시스템만 동작하는 상황
    - <b>부분 장애 (partial failure)</b> 라고 명명
- 부분 장애는 비결정적 성격을 지님
    - 성공 여부 확인 불가

### 클라우드 컴퓨팅과 슈퍼 컴퓨팅

| 고성능 컴퓨팅(HPC) | 전통적인 기업형 데이터 센터 | 클라우드 컴퓨팅 |

- 고성능 컴퓨팅
    - 일기예보 같은 계산 비용이 높은 과학 계산 작업에 사용하기 위해 CPU가 높음
- 클라우드 컴퓨팅
    - Multi Tenant Data Center, IP 네트워크 등, elastic 관련 특징과 높은 컴퓨터
- 기업형 데이터 센터는 위 두 가지 특징 중간 지점을 가짐

- 슈퍼 컴퓨터의 장애 처리
    - 노드 하나 장애 발생 시 체크포인트로 저장되어 있는 부분부터 전체 장애 처리 후 재시작하도록 처리
- 인터넷 서비스는 위와 결이 다른 형태
    - 낮은 지연 시간을 가져야 하며, 전체 서비스 중단은 비허용
    - 상용 장비를 사용하며, Failover 가능성이 슈퍼컴퓨터보다 상대적으로 높음
    - IP, 이더넷 기반 통신
    - 시스템이 비대해 질 수록 결함 가능성 상승
    - 인터넷을 사용할 경우 속도가 느리고 신뢰성 하락
- 소프트웨어는 결함이 필수적으로 발생한다 가정하고 이를 대비하기 위한 설계 필요

#### 신뢰성 없는 구성 요소를 사용해 신뢰성 있는 시스템 구축하기

- 하위 계층의 오류를 상위 계층의 요소를 사용해 신뢰성을 높히는 방법
    - OSI 3계층 Network 계층(IP)의 신뢰성을 위해 4계층 Transport(TCP)를 사용하여 손실된 패킷을 재전송하고 중복된 것을 제거
    - 네트워크 계층의 오류를 어플리케이션 레이어에서 정확히 전송하도록 처리하는 것

## 신뢰성 없는 네트워크

- 분산 시스템은 주로 비공유 시스템으로 구성
- 비공유 시스템은 네트워크를 통해 통신
    - 상대적으로 저렴
    - 여러 데이터 센터에 중복 배치하여 높은 신뢰성 보장
- 대부분 <b>비동기 패킷 네트워크</b>로 구성
- 데이터 전달 과정에서 실패 가능성 존재
    1. 데이터 손실
    2. 데이터 지연
    3. 수신 노드 장애
    4. 수신 노드 지연 및 응답 지연
    5. 네트워크 과정 손실
    6. 하드웨어 과부하로 인한 응답 지연
- 위 문제를 해결하기 위한 유일한 인식 방법 = <b>타임아웃</b>

### 현실의 네트워크 결함

- 네트워크 결함은 언제든지 발생 가능하고 이를 소프트웨어가 처리할 필요성 존재
- 해결이 어려울 경우 오류 메시지 전달 후 재시도 처리하도록 할 수도 있음

### 결함 감지

- 시스템은 결함 노드 감지가 필요
    - 로드밸런서는 죽은 노드에 데이터 전송을 멈춰야 함
    - 팔로워 중 하나가 리더로 승격해야 함

- 노드 감지에 대한 피드백 종류
    - 수신 대기하는 프로세스의 존재 유무로 판단
    - 운영체제가 인지할 경우 다른 노드로 역할을 넘겨줌
    - 질의를 통해 하드웨어 장애 파악
    - IP 주소가 다다를 수 없는 경우 제한 적용
- 일반적으로 ACK를 통해 성공 확신, 타임아웃을 통해 노드가 죽었다고 인지

### 타임아웃과 기약 없는 지연

- 타임아웃이 길 경우 죽었다고 기다리는 시간이 길어짐
- 짧을 경우 느려짐을 죽었다고 판단할 경우가 생김 -> 중복 실행 / 과부화 악화의 원인
- 결론 : 답은 없음
- 일반적으로 d : 전송 시간 / r을 요청 처리 시간이라고 했을 때 2d + r을 타임아웃 시간으로 잡는 것이 합리적

#### 네트워크 혼잡과 큐 대기

- 네트워크의 지연 변동성은 큐 대기의 가능성이 높음
    - 네트워크가 잘 동작하더라도 입력과 출력 상의 슬롯이 없을 경우 기다려야 하는 경우가 많음
    - CPU 코어를 사용하는 동안 바쁠 경우 운영체제 큐에 넣어놓음
    - 가상 장비 모니터는 데이터를 큐에 넣어 버퍼링
    - TCP는 송신율을 제한 <b>(흐름 제어, 배압)</b>
- 공개 클라우드나 멀티 tenant 데이터 센터에서는 자원을 공유 함으로 지연 변동이 클 수 있음
- 이 때는 타임 아웃을 유동적으로 변동성을 측정하고 자동으로 timeout 값을 조정토록 진행

##### TCP vs UDP

- 지연된 데이터에 대한 유실 가능성을 무시할 경우 UDP 사용
- 동영상이나 통화 등

### 동기 네트워크 대 비동기 네트워크

- 패킷 최대 전송량을 조정하고 고정된 비율로 보내서 동기식으로 처리 - <b>제한 있는 지연</b>

#### 네트워크 지연을 예상가능 하도록 조정

| | TCP 회선 | 전화 회선 |
| -- | -- | -- |
| 최적화 | 순간적으로 몰리는 트래픽에 최적화(요구 사항 없음) | 초당 비트 개수가 고정 |
| 유동성 | 네트워크 용량에 맞춰 데이터 전송율 동적 조정 가능 | 고정되어 있기 때문에 네트워크 용량 낭비 및 전송이 느려짐 |

- 하이브리드 네트워크
    - 회선 교환과 패킷 교환 모두 지원
    - 링크 계층에서 종단 흐름 제어 구현 지연의 영향을 받을 수 있음
    - 서비스 품질 보장 불가