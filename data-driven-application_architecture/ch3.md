# 3장 저장소와 검색

데이터 베이스의 역할이란?

- 데이터를 저장
- 저장한 데이터를 호출

이 장의 목표

- 작업에 따른 적합한 엔진 채택을 위해 저장소 엔진이 수행하는 작업을 이해
- No SQL 저장소 엔진 분석
    - 로그 구조 계열 저장 엔징
    - 페이지 지향 계열 저장소 엔진

## 데이터베이스를 강력하게 만드는 데이터 구조

가장 기본적인 구조의 DB

- Key - Value 형태의 DB
- 예전 값을 덮어 쓰지 않고 파일의 끝에 추가
- DB에 값이 많을 수록 검색 비용이 큼
- 검색 비용을 줄이기 위한 방법 = 색인

색인의 특징

- 기본 데이터에서 파생된 추가적인 구조
- DB의 내용과는 별개로 다룸
- 쓰기 과정에서 오버헤드 발생

### 해시 색인

색인 전략 종류

- 키를 데이터 바이트 오프셋에 매핑하여 해시 맵 유지 - 비트캐스크
    - 키의 값이 자주 갱신 되는 경우
    - 데이터 파일의 일부가 파일 캐시에 있다면 읽기에 디스크 출력 X

- 특정 크기에 도달하였을 때 세그멘트로 로그를 나누는 방식 - 컴팩션
    - 하나의 파일을 만들고 세그먼트 병합 후 이전 세그먼트 삭제
    - 구현에서 중요한 요소
        - 파일형식 : 바이너리 방식 사용
        - 레코드 삭제 : 레코드 삭제 과정에서 이전에 추가된 값을 무시
        - 고장 복구 : 세그 먼트 값이 크면 복구가 어려움
        - 부분적 레코드 쓰기 : 체크섬을 통해 손상된 부분만 탐지 후 복구 가능
        - 동시성 제어 : 쓰기를 엄격하게 할 경우 쓰기 쓰레드를 하나만 사용

- 추가 전용 설계의 장점
    - 순차적인 쓰기 작업이라 훨씬 빠름
    - 추가 전용이라 고장 복구가 훨씬 간편

- 단점
    - 메모리 저장하는 내용이라 키가 많으면 문제
    - 확장 비용이 비쌈
    - Range Scan이 비효율

### SS 테이블과 LSM 트리

SS테이블 - 세그먼트 파일 형식과 다른 점

- 키-값 쌍을 키로 정렬
- 가장 최근의 세그먼트 값만 유지
- 모든 값을 알 필요 없고 가까운 오프셋에서 이동하는 방시긍로 찾기 가능

#### SS 테이블 생성과 유지

키 정렬 방법
- 유입되는 쓰기는 임의의 순서로 발생

저장소 엔진 만드는 방법
- 쓰기가 들어오면 Red-black Tree 같은 자료구조에 데이터 추가 - 트리를 멤테이블이라 부름
- 새로운 SS테이블 파일은 데이터베이스의 가장 최신 세그멘트
- 백그라운드에서 컴팩션 과정을 수행

#### SS 테이블에서 LSM 트리 만들기

알고리즘 적용 DB

- 레벨 DB
- 록스 DB
- 유사 - 카산드라, Hbase

루씬
- 엘리스틱 서치나 솔라에서 사용하는 전문 검색 엔진
- 단어에 대한 모든 문서를 Key-Value로 구현
- 키는 단어, 값은 단어를 포함한 모든 ID List

#### 성능 최적화

LSM 트리 알고리즘의 단점

- 존재 하지 않는 필터 검색 시 모든 데이터 탐색 필요
- 이를 대응하기 위한 블룸 필터 사용

SS테이블을 압축하고 병합하는 순서와 시기를 결정하는 전략

- 크기 계층
- 레벨 컴팩션

LSM 트리의 기본 개념

- SS테이블을 지속 병합
- 높은 쓰기 처리량 보장

### B 트리

특징

- 블록이나 페이지로 나누면 하나의 페이지 쓰기와 읽기를 진행
- 페이지 트리 형태로 구현
- 새로운 키에 빈칸이 없을 때, 하나를 반쯤 채워진 두 페이지로 분리

신뢰할 수 있는 B트리 만들기

- B트리의 기본적인 동작은 물리 데이터를 덮어 씀
- 

### B 트리와 LSM 트리 비교 

### 기타 색인 구조

## 트랜잭션 처리와 분석?

### 데이터 웨어 하우징
### 분석용 : 별 모양 스키마와 눈꽃송이 모양 스키마

## 칼럼 지향 저장소

### 칼럼 압축
### 칼럼 저장소와 순서의 정렬
### 칼럼 지향 저장소에 쓰기
### 집계 : 데이터 큐브와 구체적 뷰