# ch12 데이터 시스템의 미래

- 신뢰할 수 있고 확장 가능하며 유지 보수 쉽게 만드는 방법을 탐구 하는 방법

## 데이터 통합

- 가장 적절한 도구를 선택하는 것은 상황에 따라 다름
    - 선택지가 많으면, 소프트웨어 제품과 환경 사이의 대응관계를 파악
    - 모든 환경 조건을 만족하는 소프트웨어는 없기 때문에, 다른 소프트웨어와 잘 묶어 사용 해야 함

### 파생 데이터에 특화된 도구의 결합

- OLTP DB는 특정 키워드 기반 쿼리를 추가 요구하는 것은 빈번하게 존재
    - PostgreSQL의 경우 간단한 DB를 만들기는 쉽지만 전문 탐색 도구가 필요
    - 역색인 검색 색인은 지속성 있는 레코딩 시스템으로 부적합하여 위 PostgreSQL과 결합하는 방식으로 사용하면 좋음
- 데이터 통합의 필요성은 전체 데이터 플로우를 고려해야 함

#### 데이터플로에 대한 추론

- 데이터 사본을 여러 저장소 시스템에 유지가 필요할 시 입력과 출력을 분명히 해야함
    - 데이터 초기 기록 위치, 원본에서 파생되는 데이터 표현형, 데이터가 올바른 장소로 올바른 형식으로 들어가는 지 충분히 고려해야 함
- 검색 색인이 이를 직접 기록하게 한다면, 문제가 발생 가능성이 높아짐
    - 파생 데이터 시스템은 이벤트 로그를 기반으로 갱신하면 결정적이고 멱등성을 지니고 복구가 쉬움

#### 파생 데이터 대 분산 트랜잭션

- 파생 데이터와 분산 트랜잭션의 차이
    - 트랜잭션 시스템은 일반적으로 *선형성*을 지원
    - 파생 데이터 시스템은 대개 비동기로 갱신되어 동시간 갱신 보장을 미지원
- 로그 기반 파생 데이터가 좋은 접근성
    - XA는 결함 대응에 취약 및 성능이 안 좋음
- **최종적 일관성**을 어떻게 다루는 지가 중요

#### 전체 순서화의 제약

- 작은 시스템에서 이벤트 로그 순서 전체를 보장이 가능하지만 규모가 커지만 한계 등장
    - 모든 이벤트가 **단일 노드 리더**로 통하지 않으면 규모가 커지면 복수의 장비로 파티션 필요 -> 이벤트 순서 애매
    - 지역적 분산 데이터센터는 독립적 리더를 두어야 함
    - 마이크로 서비스는 서비스 간 상태는 비공유
    - 클라이언트는 서버의 응답을 기다리지 않고 지속 갱신
- 이벤트 전체 순서를 정하는 것은 **전체 순서 브로드캐스트** 라고 지칭
    - 합의와 동등하지만 아직 미해결 연구 과제

#### 인과성 획득을 위한 이벤트 순서화

- 이벤트 간 인과성이 없는 경우에는 순서가 정해지지 않아도 문제 X
- SNS 기준 친구 끊기와 메시지 보내기는 의존성 X
    - 다만 조인의 타이밍만 문제와 관련
    - 논리적 타임 스탬프를 사용할 경우 전체 순서화를 지원
    - 시스템 상태를 기록하는 이벤트를 로깅할 수 있고 식별자를 참조할 수 있음
    - 충돌 해소 알고리즘은 예상치 못한 순서로 전송된 이벤트를 처리하는 데 도움을 줌

### 일괄 처리와 스트림 처리

- 데이터 통합의 목표는 데이터를 올바른 장소에 올바른 형태로 두는 것
- 일괄 처리와 스트림 처리의 출력은 파생 데이터 셋
- 두 처리 간의 여러 공통 원리가 있지만, 스트림 처리는 끝이 없는 데이터셋 운영, 일괄 처리는 유한한 크기를 처리
- 스파크는 일괄 처리 엔진 상에서 스트림 처리, 스트림을 마이크로 일괄 처리 단위로 나누어 처리
    - 아파치 플링크는 스트림 처리 엔진 상에서 일괄 처리 수행

#### 파생상태 유지

- 일괄 처리는 함수 프로그래밍 언어로 코드를 사용하지 않아도 강력한 함수형 특징을 지님
    - 일괄 처리는 결정적이고, 출력이 입력에만 의존하며 순수 함수 장려
    - 스트림 처리도 유사하지만, 연산자 확장해서 상태 관리가능 하면 내결함성을 지님
- 입출력을 잘 정의한 결정적 함수는 내결함성에 도움이 될 뿐 아니라 조직 내 데이터 플로 추론을 단순화
    - 데이터 파이프라인의 관점에서 생각하는 것이 좋음
    - 데이터 파이프라인은 함수형 코드를 통해 상태 변화를 밀어 넣고 결과를 파생 시스템에 적용
- 이론 상으로 파생 데이터 시스템은 트랜잭션 내 보조 색인을 동기식으로 갱신하여 동기식 처럼 운영 가능
    - 비동기 방식은 이벤트 기반 로그 시스템을 견고하게 만듬
    - 분산 트랜잭션은 장비 일부 실패 시 abort하기 때문에 실패가 증폭되는 경향이 있음
- 보조 색인을 가진 파티셔닝 시스템이 색인을 용어 기준으로 파티셔닝 시 복수 파티셔닝에 요청을 보내야 함
    - 문서 기준이면 모든 파티션에 보내야 함
    - 비동기 방식이면 이런 통신을 신뢰성있고 확장성이 좋게 유지 가능

#### 애플리케이션 발전을 위한 데이터 재처리

- 파생 데이터를 유지할 때 일괄 처리와 스트림 처리는 상당히 유용
    - 스트림 처리 시 입력의 변화를 빠르게 파생 뷰 반영 가능
    - 일괄 처리 사용시 누적된 상당량의 과거를 처리해서 파생뷰를 만들기 가능
- 기존 데이터를 재처리하는 것은 시스템을 유지보수하여, 기능 추가와 변경 요구 사항에 대응하기 위함
- 파생 뷰 사용 시 점진적 발전 가능
    - 기존 뷰와 새 뷰의 비율 조정을 통해 기존 뷰를 내리는 방식
- 점진적 이전은 오처리 시 원복 가능하여 시스템을 빠르게 개선 가능

#### 람다 아키텍처

- 일괄 처리는 과거 데이터 처리, 스트림처리는 최근 갱신 데이터 처리 이를 합친 것이 **람다 아키텍처**
- 입력 데이터를 분변 이벤트로서 증가하기만 하는 데이터 셋에 기록하는 방법 - 이벤트 소싱과 유사
    - 하둡 맵리듀스와 같은 일괄 처리 시스템과 스톰 같은 스트림 시스템을 같이 운용
- 람다 아키텍처 접근 법에서 이벤트를 소비해서 빠르게 뷰에 반영, 이후 일괄 처리자가 같은 이벤트 집합을 소비해서 정확한 파생 뷰 반영
    - 일괄 처리는 버그가 적고 간단 그러나 느리고 정확한 알고리즘
    - 스트림 처리는 신뢰성이 떨어지고 내결함성 확보의 어려움 그러나 빠른 근사 알고리즘
- 람다 아키텍처는 불변 이벤트 스트림에 대한 뷰를 파생하고 필요할 때 이벤트를 재처리하는 원리 제공
- 람다 아키텍처의 문제점
    - 일괄 처리와 스트림 처리 모두 같은 로직 유지 필요
    - 스트림 파이프라인과 일괄 처리 파이프 라인은 분리된 출력 생산
    - 과거 데이터를 재처리할 수 있으나 비용이 큼

#### 일괄 처리와 스트림 처리의 통합

- 일괄 처리와 스트림 연산을 모두 구현하여 장점만 취할 수 있는 작업을 위해 아래 기능 필요
    - 이벤트 스트림 내에 과거 이벤트를 재생하는 능력 존재
    - 스트림 처리자에서 사용되는 exactly at once 시맨틱
    - 이벤트 시간 기준으로 윈도를 처리하는 도구

## 데이터베이스 역번들링



### 데이터 저장소 기술 구성하기

#### 색인 생성하기
#### 모든 것의 메타데이터베이스
#### 언번들링이 동작하게 만들기
#### 언번들링 대 통합 시스템
#### 뭐가 빠졌지?

### 데이터플로 주변 애플리케이션 설계

#### 파생 함수로서의 애플리케이션 코드
#### 애플리케이션 코드와 상태 분리
#### 데이터플로: 상태 변경과 애플리케이션 코드 간 상호 작용
#### 스트림 처리자와 서비스

### 파생 상태 관찰하기

#### 구체화 뷰와 캐싱
#### 오프라인 대응 가능한 상태 저장 클라이언트
#### 상태 변경을 클라이언트에게 푸시하기
#### 종단 간 스트림
#### 읽기도 이벤트다
#### 다중 파티션 데이터 처리

## 정확성을 목표로

### 데이터베이스에 관한 종단 간 논증

#### 연산자의 정확히 한 번 실행
#### 중복 억제
#### 연산 식별자
#### 종단 간 논증
#### 종단 간 사고를 데이터 시스템에 적용하기

### 제약조건 강제하기

#### 유일성 제약 조건은 합의가 필요하다
#### 로그 기반 메시징의 유일성
#### 다중 파티션 요청 러리

### 적시성과 무결성

#### 데이터 플로 시스템의 정확성
#### 느슨하게 해석되는 제약 조건
#### 코디네이션 회피 데이터 시스템

### 믿어라 하지만 확인하라

#### 소프트웨어 버그가 발생해도 무결성 유지하기
#### 약속을 맹목적으로 믿지 마라
#### 검증하는 문화
#### 감사 기능 설계
#### 다시 종단 간 논증
#### 감사 데이터 시스템용 도구

## 옳은 일 하기

### 예측 분석

#### 편견과 차별
#### 책임과 의무
#### 피드백 루프

### 사생활과 추적

#### 동의와 선택의 자유
#### 사생활과 데이터 사용
#### 자산과 권력으로서의 데이터
#### 산업 혁명의 기억
#### 법률과 자기 규제