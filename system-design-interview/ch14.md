# ch14 유튜브 설계

## 문제 이해의 및 설계 범위 확정

- 비디오 업로드
- 원활한 비디오 재생
- 재생 품질 선택 기능
- 낮은 인프라 비용
- 높은 가용성과 규모 확장성, 그리고 인정성


### 규모 추정

- DAU : 5백만
- 비디오 평균 크기 : 500MB
- 일당 저장용량 : 150TB
- CDN 비용 : 150000

## 개략적 설계안 제시 동의 구하기

- 시스템은 세 개의 컴포넌트로 구성
    - 단말(Client) - 컴퓨터 모바일 폰, 스마트 TV
    - CDN - 비디오는 CDN에 저장 (스트리밍)
    - API서버 : 피드 추천, 비디오 업로드 등 API서버에서 처리

- 설계 영역
    - 업로드 영역
    - 다운로드 영역

### 업로드 절차

- 컴포넌트 구성
    - 로드밸런서
        - API 분산 담당
    - API 서버
        - 스트리밍을 제외한 기타 작업
    - 메타데이터 데이터베이스
        - 메타데이터 보관
    - 원본 저장소
        - 원본 비디오를 저장할 이진 파일 저장소
    - 트랜스코딩 서버
        - 인코딩을 하는 저장소 비디오 스트림을 제공
    - 트랜스코딩 비디오 저장소
        - 트랜스 코딩이후 저장할 BLOB 저장소
    - CDN
        - 비디오 캐시
    - 트랜스코딩 완료 큐
        - 완료 이벤트를 저장할 메시지큐
    - 트랜스코딩 완료 핸들러
        - 메타데이터 캐시와 데이터베이스를 갱신


### 비디오 업로드

1. 원본 저장소에 업로드
2. 비디오를 가져와 트랜스 코딩
3. 트랜스 코딩 이후 완료 큐에 넣기
    1) CDN에 넣기
    2) 완료 핸들러가 큐에서 꺼내기
    3) 메타데이터 DB와 캐시를 갱신
4. 스트리밍 준비 완료

### 메타데이터 갱신

1. 메타데이터 정보를 업데이트
    
### 스트리밍 절차

- 스트리밍 프로토콜은 정확하게 외울 필요는 X
- 각 기기에 따른 방법이 다르다는 것만 기억

## 상세 설계

### 트랜스 코딩

- 트랜스코딩의 이유
    - 비가공 데이터는 저장공간이 너무 크다
    - 특정 단말은 특정 비디오 포맷만 지원
    - 네트워크 환경에 따른 화질 차이
    
- 인코딩 종류   
    - 컨테이너
        - 메타 데이터를 담는 바구니 같은 것
    - 코덱
        - 화질은 보존하면서 파일을 크기를 줄일 수 있는 압축 


### DAG 모델

- 각기 다른 유형에 대한 파이프라인을 지원
- 병렬성을 높히기 위한 추상화 도입
- 구현
    - 검사
        - 비디오의 품질 점검
    - 인코딩
        - 해상도, 코딩, 비트레이트 조합
    - 썸네일 추출
        - 이미지나 비디오 자동 추출하여 썸네일 생성
    - 워터마크

### 트랜스코딩 아키텍처
- 전처리기
- DAG 스케줄러
- 자원 관리자
- 작업 실행 서버
- 임시 저장소

#### 전처리기
- 비디오 분할
    - GOP 단위를 지정하여 쪼갬 (이를 독립적으로 실행 가능)
- DAG 생성
    - 2개의 노드와 한개의 연결선으로 구성
- 데이터 캐시
    - 비디오 인코딩

#### DAG 스케줄러
- DAG 스케줄러는 몇 개 단계로 분할한 다음에 작업 큐에 넣음
- 분할
    1. 비디오, 오디오, 메타데이터를 분리
    2. 해당 비디오 파일을 인코딩 / 썸네일 추출 / 오디오 파일 추출

#### 자원 관리자
- 큐의 종류 
    - 작업 큐
    - 작업 서버 큐 (가용 상태 정보 보관)
    - 실행 큐 (실행 중인 서버 보관)

#### 작업 서버
- 실제 작업을 진행하는 서버


### 시스템 최적화

#### 속도 최적화
- 병렬 업로드 : GOP 단위로 분할
- CDN 근거리 지정
- 프로세스 병렬화 : 각 큐 메시징 처리
