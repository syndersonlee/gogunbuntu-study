# ch15 구글 드라이브 설계

## 문제의 이해와 설계 범위 설정

### 기능

- 파일 추가
- 파일 다운로드
- 여러 단말 간 파일 동기화
- 파일 갱신 이력 조회
- 파일 공유
- 파일 편집 혹은 삭제 시 알림 표시

### 비기능 요구사항

- 안정성
- 빠른 동기화
- 네트워크 대역폭
- 규모 확장성
- 높은 가용성

## 개략적 설계안 제시 및 동의 구하기

- 가장 간단한 서버 형태
    - 파일 업로드 다운로드를 담당할 웹 서버
    - 사용자 데이터 / 로그인 정보 / 파일 정보를 구분할 메타 데이터 베이스
    - 파일 저장소 시스템

### API

시스템에서 제공하는 API 종류

1. 파일 업로드 API
    - 단순 업로드
    - 이어 올리기 : 파일 사이즈가 크고 네트워크 이슈 가능성이 있는 경우
        - 절차
            1. 이어 올리기 URL을 받기 위한 최초 Requeust 전송
            2. 데이터를 업로드 하고 모니터링
            3. 장애 시 장애 발생 시점부터 업로드 재시작

2. 파일 다운로드 API
    - 갱신 히스토리를 가져올 파일 경로
    - 히스토리 길이 최대치

### 한 대 서버의 제약 극복

- 가용성 보장하는 저장소 구현
    - user_id 기준으로 샤딩하여 저장 
    - 저장소로 S3를 저장하는 대안 존재
- 추가 고려안 및 고려할 컴포넌트
    - 로드밸런서
    - 웹 서버
    - 메타 데이터 베이스 : SPOF 회피하기 위해 분리
    - 파일 저장소

### 동기화 충돌

- 동시에 업데이트 하는 경우?
    1. 하나로 합치기
    2. 대체하기

### 설계안

- 블록 저장소  
    - 여러 블록으로 나누어 저장 / 각 블록에는 고유한 해시 값을 할당
    - 블록들을 원래 순서대로 합쳐야 함 (드랍박스의 경우 최대 4MB)

- 클라우드 저장소
    - 파일은 블록 단위로 나뉘어 클라우드 저장소 보관

- 아카이빙 저장소
    -  비활성화된 데이터를 저장

- 로드밸런서
- 메타데이터 베이스
- 메타데이터 캐시
- 알림 서비스
    - 특정 이벤트가 발생했을 때 클라이언트에 알림 (최신 상태 유지)
- 오프라인 사용자 백업 큐
    - 클라이언트가 나중에 접속 했을 때 동기화 될 수 있도록 함

### 상세 설계

#### 블록 저장소 서버

- 델타 동기화 : 파일이 수정되면 블록만 동기화
- 압축 : 파일 유형에 따라 압축 파일은 다르지만, 알고리즘이 달라진다.

#### 높은 일관성 요구 사항

- 높은 일관성 요구 사항 지원
- 메모리 캐시는 최종 일관성 모델을 지원
    - 캐시에 보관된 사본과 데이터베이스 원본을 일치 
    - DB 보관된 원본이 변경 발생시 캐시 Evict

RDBMS는 ACID 보장하여 강한 일관성 보장

#### 업로드 절차

- 파일 메타데이터 추가
    1. 메타데이터 요청 전송
    2. 새 파일의 메타데이터 저장 후 pending으로 변경
    3. 새 파일 추가에 대한 알림 서비스 통지
    4. 알림 서비스는 클리이언트에게 파일 업로드

- 파일을 클라우드에 업로드
    1. 파일을 블록 저장소에 업로드
    2. 블록 단위로 쪼갠 다음 압축하고 암호화 한다음 클라우드 저장소에 전송
    3. 업로드가 끝나면, 클라우드에서 완료 콜백 호출하여 api서버 전송
    4. 메타 DB 상 Pending을 완료로 변경
    5. 알림 서비스를 완료 통지
    6. 알림 서비스는 파일 업로드가 끝남을 알림

#### 다운로드 절차

타 클라이언트가 편집이나 추가를 했을 경우
- 클라이언트 A에게 변경 발생 시 새 버전 통지가 필요
- 클라이언트 A가 네트워크에 연결된 상태가 아닐 경우 데이터를 캐시에 보관

1. 알림 서비스가 클라이언트에게 변경 전파
2. 변경 메타 정보를 요청
3. API서버는 메타 데이터 DB에 데이터 가져와서 반환
4. 클라이언트는 블록데이터 서버에 다운로드 받아 다운로드

#### 알림 서비스

- 롱 폴링
- 웹 소켓

#### 저장소 공간 절약

- 중복 제거

- 중복 제거
- 지능적 백업 전략
    - 한도설정 : 보관하는 버전의 상한
    - 중요 버전만 보관 : 중요한 것만 골라 내야함
- 아카이빙 저장소로 옮기기

#### 장애 처리

- 로드 밸런서 장애 : 로드 밸런서간 하트 비트를 통한 상태 모니터링
- 블록 저장소 장애 : 타 서버 미완료 상태 점검
- API 서버 장애
- 메타 데이터 캐시 장애
- 메타 데이터 데이터베이스 장애
- 알림 서비스 : 롱 폴링 서비스를 복구하는 것은 상대적으로 느림

