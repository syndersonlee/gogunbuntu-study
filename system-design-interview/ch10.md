# 10장 알림 시스템 설계

### 해결 해야할 사항

- 알림 유형별 지원 방안
- 연락처 정보 수집 절차
- 알림 전송 및 수신 절차

### 알림 유형별 지원 방안

#### iOS 푸시 알림

- 알림을 보내기 위해서는 3가지 컴포넌트가 필요

1. 알림 제공자
    - 아래 정보가 필요
        - Token : 알림 요청을 보내는 데 필요한 고유 식별자
        - Payload : 알림 내용을 담은 JSON Dictionary
    
2. APNS
    - 애플이 제공하는 원격 서비스

3. iOS 단말
    - iOS 단말 : 푸시 알람을 수신하는 사용자 단말

#### 안드로이드 푸쉬 알림

1. APNS -> FCM으로 바뀌는 점만 다르다

#### SMS 메시지

- 일반적으로 Twilio, Nexmo 같은 제 3 사업자 서비스를 이용
- 비용이 발생

#### 이메일

- 고유 이메일 서버를 구축하여 사용하거나 상용서비스 사용
- SendGrid, Mailchimp 등이 존재 - 데이터 분석 제공 및 전송 성공률도 높음

### 연락처 정보 수집 절차

- 모바일 단말 토큰, 전화번호, 이메일 주소 등 정보가 필요
- 한 사용자가 다양한 단말 구조를 가질 수 있으므로 user:device는 1:N로 구성

### 알림 전송 및 수신 절차

- 수많은 서비스 : 알림을 보내는 주체들 (시스템)
- 알림 시스템 : 알림 전송/수신 처리의 핵 -> 제 3자 서비스에 전달할 알림 페이로드 생성하는 주체
- 제 3자 서비스 : 알림을 실제 사용자에게 전달하는 역할 / 특정 서비스가 지엽적으로 사용가능하거나 특정 단말 기기에 대한 제한이 있을 수 있음으로 확장성 고려 필요

- 문제점
    - SPOF : 서버가 하나일 경우 서버에 장애가 생기면 전체 서비스에 장애가 발생
    - Scalablity : 데이터베이스나 캐시 등 컴포넌트 규모를 늘릴 방법이 없음
    - 병목 : 트래픽이 많이 몰릴 경우에는 시스템이 과부하 상태에 빠질 가능성 존재

#### 개선안

1. DB와 캐시를 주 서버에서 분리
2. 알림 서버를 다중화하여 Scale-out할 수 있는 구조로 변경
3. Message Queue를 활용하여 메시지 작업 서버와의 Coupling lose

- 알림 서버 기능
    - 알림 전송 API : 스팸 방지를 위해 사내 서비스 또는 클라이언트만 사용하도록 함
    - 알림 검증 : 이메일 주소, 전화번호 등에 대한 기본적인 검증 수행
    - 데이터베이스 또는 캐시 질의 : 알림에 포함시킬 데이터를 가져오는 기능
    - 알림 전송 : 알림 데이터를 메시지 큐에 넣어 처리

- 구성 요소
    - 캐시 : 사용자 정보, 단말 정보, 알림 템플릿 등 캐시
    - 데이터베이스 : 사용자 알림, 설정 등을 저장
    - 메시지 큐 : 의존성을 제거하고 버퍼 역할 진행
    - 작업서버
    - 제 3자 서비스
    - 단말

## 상세 설계

- 고려 할 사항
    - 안정성
    - 알림 템플릿, 설정, 전송 제한률, 재시도 매카니즘, 보안, 모니터링, 이벤트 추적

#### 안정성

#### 데이터 손실 방지

- 큐에서 받은 데이터에 대해 DB를 구축하여 재시도 매커니즘을 구축해야 함

#### 알림 중복 전송 방지

- 완전 방지는 불가능 하기 때문에 중복 전송을 방지해야 한다.
- 이벤트 ID를 검사하여 이전에 본적 있는지 확인해야 함

### 추가 확인 사항

#### 알림 템플릿

- 양식으로 만들어 알림으로 바로 보낼 수 있도록 작성

#### 알림 설정

- 채널 별 분리, 알림 종류, 여부 등을 체킹

#### 전송률 제한

- 전송 하는 빈도는 계산하여 확인

#### 재시도 방법

- 재시도 전용 큐에 넣어서 개발자에게 통지

#### 푸시 알림과 보안

- appKey와 appSecret을 통해 보안을 유지

#### 큐 모니터링

- 메트릭을 통해 서버를 확인

#### 이벤트 추적

- 알림 확인율, 클릭율, 실제 앱 사용으로 이어지는 비율

### 수정 설계

- 기존 서비스에 데이터를 수집하는 metric (분석 서비스)를 추가하여 각 서버의 로그를 수집
- 작업 서버에 알림 템플릿을 넣어 데이터를 정리
- 알림 서버에 인증인가/전송률 제한 기능을 넣어 알림 진행
- 전송 실패한 일림 서비스에 대해서 큐에 다시 넣고 재시도 진행


