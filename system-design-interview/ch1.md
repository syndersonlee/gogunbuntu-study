# Ch1 Scaleablity by user

### 단일 서버

#### 사용자 요청 처리 시스템

1. 도메인 이름으로 접속하여 IP로 변환하기 위해 DNS 서버 조회
2. DNS 조회 결과로 IP 주소 반환
3. 해당 IP 주소로 HTTP 요청 전달
4. 요청 웹 서버로 JSON 형태의 응답 반환

- 실제 요청은 웹 어플리케이션 혹은 모바일 단말을 통해 접근

### DB 서버

서버는 크게 두 가지 정도로 구분이 되는데, 1. 웹/모바일 트래픽 처리 용도 2. 데이터베이스 서버 처리 용

- RDMBS의 종류 : MySQL, 오라클, PostgreSQL - 테이블을 조인해서 사용
- NoSQL의 종류 : 비관계형 SQL 키-값 저장소, 그래프 저장소 - 조인 연산은 불가능
    - NoSQL이 좋은 케이스
        - 아주 낮은 latency 요구
        - 다루는 데이터 관계형 데이터가 아닌 비정형
        - 데이터(JSON, YAML)을 직렬화 하거나 역직렬화 가능해야 함
        - 아주 많은 양의 데이터 저장

### Scale-up VS Scale-out

- 수직적 확장에는 한계가 존재
    - fail-over이나 다중화 방안을 제시 할 수 없는 구성
    - 웹 서버가 다운 되면 접속 불가능

- 수평적 확장을 위해 로드 밸런서를 도입
    - 웹 서버와 통신 하기 위해 내부적으로 쓰이는 private ip를 이용
    - fail-over 문제를 해결 가능하며, 부하를 나누기 위해 새로운 서버 추가가능
    - 로드밸런서가 있기 때문에 트래픽을 자동 분산


### 데이터베이스 다중화

- 서버 사이에 Master-slave 관계를 설정하여, 데이터 원본은 주 서버에 사본은 부서버에 저장하는 방식
- write 연산은 마스터에서만 지원, 부 데이터베이스는 사본을 전달 받아 read 연산만 지원
- 대부분의 애플리케이션은 read 연산이 많기 때문에 아래와 같은 장점이 발생 
    - 병렬로 처리할 수 있는 Query가 많아져 성능이 좋아짐
    - 데이터를 다중화 하여 데이터 보존
    - 데이터가 장애가 발생하더라도 다른 서버의 데이터를 가져와 서비스 가능

아키텍쳐 개선

1. 주 DB와 부 DB 분리
2. 로드밸런서를 통해서 WAS를 스케일 아웃

### 캐시

- 연산 결과가 오래걸리거나 자주 참조되는 데이터를 메모리 안에 두고, 뒤 이은 요청이 빨리 처리 될수 있도록 하는 저장소
- 데이터가 캐시에 있으면 캐시를 불러오는 구조
- 캐시가 유용한 케이스
    - 데이터 갱신은 자주 일어나지 않지만, 참조는 빈번하게 일어날 경우
    - 캐시 서버 재시작 시 캐시 내 모든 데이터는 소멸
    - 일관성 유지도 중요
    - 캐시 서버는 분산하여 SPOF를 회피해야함
    - 캐시 데이터 방출 정책은 일반적으로 LRU를 사용

### 콘텐츠 전송 네트워크 (CDN)

- 동적 콘텐츠 캐싱
    - 요청경로, 쿠키 등을 기반하여 HTML 페이지 전체를 캐싱
- 정적 콘텐츠 캐싱
    1. 특정 이미지를 조회했을 때 CDN 서버를 먼저 조회해서 없으면 저장
    2. 있으면 가져와서 반환

- 고려 사항
    - 비용 : 자주 사용되지 않는 콘텐츠를 캐싱하는 것은 이득이 크지 않음
    - 적절한 만료 시한 : 길 경우 신선도 다운 / 짧으면 원본 서버에 부하를 너무 주는 경향
    - CDN 장애시 : 원본에서 가져오도록 설정

아키텍쳐 개선

1. CDN 서버를 두어 새로이 조회를 할 때마다 CDN 서버를 방문
2. 데이터베이스에 캐시를 두어 DB 부하를 경감

### 무상태 계층

- 관계형 데이터베이스나 NoSQL 같은 지속성 저장소에 보관
    - 상태 아키텍쳐에서는 서버에서 클라이언트의 속성을 저장하고 있어야 하고 이를 유지하기 위해 sticky session 사용 -> 비용의 증가
    - 뒷단에 아키텍쳐를 추가하기도 불편함

- 따라서 공유 저장소에 모든 정보를 저장하는 무상태 아키텍쳐로 구성하는 것이 좋음

### 데이터센터

- 장애가 없는 상태에서 가장 가까운 센터로 안내해주는 데이터 센터로 전송하여 가용성 지원
- 이를 위해
    - 트래픽 우회 : 가까운 데이터 센터로 트래픽 지원
    - 데이터 동기화 : 각 데이터 센터마다 동기화 필요 (넷플릭스의 예 참고)
        - 메시지 큐가 이를 해결하기 위한 핵심 키워드

### 메시지 큐

- 메시지 큐는 서버 간의 결합을 느슨하게 하여 소비자가 가용한 상태가 아니더라도 메시지 수신 가능
    - 크로핑이나 샤프닝, 블러핑 등의 사진 보정 애플리케이션
    - 로그, 모니터링, 매트릭을 지원할 수 있도록 커플링 추가 가능

### 수평적 확장

- 각 DB에 샤드를 두는데 해시 함수를 통해 데이터를 나누는 작업
- 샤드의 문제점?
    - 데이터의 재 샤딩
    - 유명인사 문제에 데이터를 할당하는 문제
